name: Build Official Style

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string
      config_type:
        description: 'Configuration type'
        required: true
        default: 'final-recommended'
        type: choice
        options:
          - ultra-minimal
          - final-recommended
          - advanced
          - stable

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time subversion libelf-dev
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "Cloning OpenWRT $VERSION..."
        
        rm -rf openwrt 2>/dev/null || true
        git clone https://github.com/openwrt/openwrt.git -b $VERSION
        cd openwrt
        echo "Commit: $(git log -1 --oneline)"
    
    - name: Configure for K2P
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Configuring for K2P..."
        echo "Using config type: ${{ github.event.inputs.config_type }}"
        
        # 根据配置类型选择文件
        case "${{ github.event.inputs.config_type }}" in
          "ultra-minimal")
            CONFIG_FILE="../configs/k2p-ultra-minimal.config"
            ;;
          "final-recommended")
            CONFIG_FILE="../configs/k2p-final-recommended.config"
            ;;
          "advanced")
            CONFIG_FILE="../configs/k2p-advanced.config"
            ;;
          "stable")
            CONFIG_FILE="../configs/k2p-stable.config"
            ;;
          *)
            CONFIG_FILE="../configs/k2p-final-recommended.config"
            ;;
        esac
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "Using config file: $CONFIG_FILE"
          cp "$CONFIG_FILE" .config
          
          # 验证配置
          echo "Configuration validation:"
          echo "========================="
          echo "Target device:"
          grep "CONFIG_TARGET.*DEVICE.*k2p" .config || echo "⚠️ K2P device not found!"
          
          echo ""
          echo "DNS server:"
          grep "CONFIG_PACKAGE_dnsmasq" .config || echo "⚠️ No DNS server configured!"
          
          echo ""
          echo "Wireless drivers:"
          grep "CONFIG_PACKAGE.*mt7615" .config || echo "⚠️ No MT7615 wireless drivers!"
          
          echo ""
          echo "Total packages: $(grep -c '^CONFIG_PACKAGE' .config)"
        else
          echo "❌ Config file not found: $CONFIG_FILE"
          echo "Using safe defaults..."
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
          echo "CONFIG_PACKAGE_kmod-mt7615e=y" >> .config
          echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        fi
        
        make defconfig
        
        echo "✅ Configuration applied"
    
    - name: Update feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Updating feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds updated"
    
    - name: Download packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Downloading packages..."
        mkdir -p dl
        make download -j2
        echo "Download completed"
    
    - name: Build firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Starting firmware build..."
        START_TIME=$(date +%s)
        
        # 安全并行度
        JOBS=2
        echo "Using $JOBS parallel jobs"
        
        set +e
        make -j$JOBS V=s 2>&1 | tee build.log
        BUILD_STATUS=$?
        set -e
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "Build duration: $((DURATION / 60)) minutes $((DURATION % 60)) seconds"
        
        # 关键检查：是否生成了固件文件
        FIRMWARE_FILE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
        if [ -f "$FIRMWARE_FILE" ]; then
          echo "✅ SUCCESS: Firmware generated!"
          echo "File: $(basename $FIRMWARE_FILE)"
          echo "Size: $(du -h $FIRMWARE_FILE | cut -f1)"
          echo "MD5: $(md5sum $FIRMWARE_FILE | cut -d' ' -f1)"
        elif [ $BUILD_STATUS -eq 0 ]; then
          echo "⚠️ Build completed but firmware not found"
          echo "Searching for firmware files..."
          find bin -name "*.bin" -type f 2>/dev/null || echo "No .bin files found"
        else
          echo "❌ Build failed"
          echo "Last errors:"
          tail -100 build.log | grep -i "error\|fail" | tail -10 || echo "No error patterns found"
          exit 1
        fi
    
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: k2p-${{ github.event.inputs.openwrt_version }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
        retention-days: 7
    
    - name: Create summary
      if: always()
      run: |
        echo "## K2P OpenWRT Build Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:** ${{ github.event.inputs.config_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ **Build Successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Firmware is available in the artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommended next steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the firmware from Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Flash to K2P using Breed bootloader" >> $GITHUB_STEP_SUMMARY
          echo "3. Default IP: 192.168.1.1" >> $GITHUB_STEP_SUMMARY
          echo "4. Login: root (no password initially)" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Build Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the build log for details." >> $GITHUB_STEP_SUMMARY
        fi
