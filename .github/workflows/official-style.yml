name: Build Official Style

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string
      config_type:
        description: 'Configuration type'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - with-luci

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time subversion libelf-dev
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "Cloning OpenWRT $VERSION..."
        
        rm -rf openwrt 2>/dev/null || true
        git clone https://github.com/openwrt/openwrt.git -b $VERSION
        cd openwrt
        echo "Commit: $(git log -1 --oneline)"
    
    - name: Configure for K2P
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Configuring for K2P..."
        echo "Using config type: ${{ github.event.inputs.config_type }}"
        
        CONFIG_FILE=""
        if [[ "${{ github.event.inputs.config_type }}" == "minimal" ]]; then
          CONFIG_FILE="../configs/k2p-minimal.config"
        elif [[ "${{ github.event.inputs.config_type }}" == "with-luci" ]]; then
          CONFIG_FILE="../configs/k2p-with-luci.config"
        fi
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "Using config file: $CONFIG_FILE"
          cp "$CONFIG_FILE" .config
        else
          echo "Config file not found, using minimal defaults"
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
          echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
          echo "CONFIG_PACKAGE_firewall=y" >> .config
          echo "CONFIG_PACKAGE_kmod-mt7615e=y" >> .config
        fi
        
        make defconfig
        
        echo "Configuration summary:"
        grep -E "^CONFIG_TARGET|^CONFIG_PACKAGE" .config | sort | head -20
    
    - name: Update feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Updating feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds updated"
    
    - name: Download packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Downloading packages..."
        mkdir -p dl
        make download -j$(nproc) || make download
        echo "Download completed"
    
    - name: Build firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Starting firmware build..."
        START_TIME=$(date +%s)
        
        CPU_CORES=$(nproc)
        if [ $CPU_CORES -gt 4 ]; then
          JOBS=$((CPU_CORES - 2))
        elif [ $CPU_CORES -gt 2 ]; then
          JOBS=$((CPU_CORES - 1))
        else
          JOBS=2
        fi
        
        echo "Using $JOBS parallel jobs"
        
        set +e
        make -j$JOBS V=s 2>&1 | tee build.log
        BUILD_STATUS=$?
        set -e
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "Build duration: $((DURATION / 60)) minutes $((DURATION % 60)) seconds"
        
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "Build successful!"
        else
          echo "Build failed"
          tail -50 build.log
          exit 1
        fi
    
    - name: Find firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Looking for firmware files..."
        
        TARGET_DIR="bin/targets/ramips/mt7621"
        if [ -d "$TARGET_DIR" ]; then
          echo "Found target directory"
          ls -la "$TARGET_DIR/"
          
          # 查找固件文件
          for file in "$TARGET_DIR"/*.bin; do
            if [ -f "$file" ]; then
              SIZE=$(du -h "$file" | cut -f1)
              echo "Firmware: $(basename "$file") ($SIZE)"
            fi
          done
        else
          echo "Target directory not found"
          find . -name "*.bin" -type f 2>/dev/null | head -5
        fi
    
    - name: Create firmware info
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Creating firmware info..."
        
        # 避免使用heredoc
        echo "# Firmware Information" > firmware-info.txt
        echo "OpenWRT Version: ${{ github.event.inputs.openwrt_version }}" >> firmware-info.txt
        echo "Config Type: ${{ github.event.inputs.config_type }}" >> firmware-info.txt
        echo "Build Time: $(date)" >> firmware-info.txt
        
        # 添加固件信息
        SYS_FILE=$(find bin/targets/ramips/mt7621 -name "*sysupgrade*.bin" -type f 2>/dev/null | head -1)
        if [ -n "$SYS_FILE" ]; then
          echo "Firmware File: $(basename "$SYS_FILE")" >> firmware-info.txt
          echo "Firmware Size: $(du -h "$SYS_FILE" | cut -f1)" >> firmware-info.txt
          echo "Firmware MD5: $(md5sum "$SYS_FILE" | cut -d' ' -f1)" >> firmware-info.txt
        fi
    
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: k2p-${{ github.event.inputs.openwrt_version }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/firmware-info.txt
        retention-days: 7
    
    - name: Create summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Config:** ${{ github.event.inputs.config_type }}" >> $GITHUB_STEP_SUMMARY
