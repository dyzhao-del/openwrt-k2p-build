name: Build Official Style

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string
      with_luci:
        description: 'Include LuCI web interface'
        required: false
        default: 'false'
        type: boolean
      clean_build:
        description: 'Clean build (remove cache)'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time subversion libelf-dev
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "ðŸš€ å…‹éš† OpenWRT $VERSION..."
        
        # æ¸…ç†ä¹‹å‰çš„æž„å»º
        if [[ "${{ github.event.inputs.clean_build }}" == "true" ]]; then
          rm -rf openwrt dl build_dir staging_dir tmp
        fi
        
        if [ ! -d "openwrt" ]; then
          git clone --progress https://github.com/openwrt/openwrt.git -b $VERSION
        else
          echo "å·²æœ‰openwrtç›®å½•ï¼Œæ›´æ–°..."
          cd openwrt
          git fetch origin
          git checkout $VERSION
          git pull origin $VERSION
        fi
    
    - name: Configure for K2P
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ”§ é…ç½® K2P..."
        
        # åˆ›å»ºé…ç½®
        cat > .config << 'CONFIG'
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt7621=y
CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=16
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_VMLINUX_INITRD=n
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_kmod-mt7615e=y
CONFIG_PACKAGE_kmod-mt7615-firmware=y
CONFIG_PACKAGE_kmod-mt_wifi=y
CONFIG_PACKAGE_wpad-openssl=y
CONFIG_PACKAGE_hostapd-common=y
CONFIG
        
        # æ ¹æ®è¾“å…¥æ·»åŠ LuCI
        if [[ "${{ github.event.inputs.with_luci }}" == "true" ]]; then
          echo "æ·»åŠ LuCIæ”¯æŒ..."
          cat >> .config << 'CONFIG'
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y
CONFIG
        fi
        
        # è¿è¡Œdefconfigå¡«å……å…¶ä»–é…ç½®
        echo "è¿è¡Œ defconfig..."
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "ðŸ“‹ é…ç½®æ‘˜è¦:"
        echo "========================================"
        grep -E "^CONFIG_TARGET|^CONFIG_PACKAGE" .config | sort
        echo "========================================"
    
    - name: Update feeds and download
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ“¦ æ›´æ–° feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "â¬‡ï¸ ä¸‹è½½åŒ…..."
        # åˆ›å»ºdlç›®å½•å¹¶å°è¯•å¹¶è¡Œä¸‹è½½
        mkdir -p dl
        make download -j$(nproc) || make download -j2 || make download
        
        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŒ…éƒ½å·²ä¸‹è½½
        echo "æ£€æŸ¥ä¸‹è½½..."
        if [ -f "tmp/.package-download-errors" ]; then
          echo "âš ï¸  æœ‰åŒ…ä¸‹è½½å¤±è´¥:"
          cat tmp/.package-download-errors
          echo "å°è¯•ç»§ç»­æž„å»º..."
        fi
    
    - name: Build firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘..."
        START_TIME=$(date +%s)
        
        # æ ¹æ®CPUæ ¸å¿ƒæ•°è®¾ç½®å¹¶è¡Œåº¦
        CPU_CORES=$(nproc)
        if [ $CPU_CORES -gt 4 ]; then
          JOBS=$((CPU_CORES - 2))
        elif [ $CPU_CORES -gt 2 ]; then
          JOBS=$((CPU_CORES - 1))
        else
          JOBS=2
        fi
        
        echo "ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
        
        # ç¼–è¯‘å›ºä»¶
        echo "ç¼–è¯‘å›ºä»¶..."
        make -j$JOBS V=s 2>&1 | tee build.log
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "â±ï¸  ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†$((DURATION % 60))ç§’"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
        if [ $? -eq 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ!"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          
          # æ˜¾ç¤ºæœ€åŽ100è¡Œæ—¥å¿—
          echo "æœ€åŽ100è¡Œæ—¥å¿—:"
          tail -100 build.log
          
          # æ£€æŸ¥å¸¸è§é”™è¯¯
          grep -i "error\|failed\|missing" build.log | tail -20
          exit 1
        fi
    
    - name: Find and verify firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ” æŸ¥æ‰¾å›ºä»¶..."
        
        # æŸ¥çœ‹ç›®æ ‡ç›®å½•
        if [ -d "bin/targets/ramips/mt7621" ]; then
          echo "ðŸ“ ç›®æ ‡ç›®å½•å†…å®¹:"
          ls -la bin/targets/ramips/mt7621/
          
          echo "ðŸ“Š å›ºä»¶æ–‡ä»¶:"
          for file in bin/targets/ramips/mt7621/*.bin; do
            if [ -f "$file" ]; then
              SIZE=$(du -h "$file" | cut -f1)
              echo "  $(basename "$file") - $SIZE"
            fi
          done
          
          # æ£€æŸ¥sysupgradeå›ºä»¶
          SYS_FILE=$(ls bin/targets/ramips/mt7621/*sysupgrade*.bin 2>/dev/null | head -1)
          if [ -n "$SYS_FILE" ] && [ -f "$SYS_FILE" ]; then
            echo "âœ… æ‰¾åˆ°ç³»ç»Ÿå‡çº§å›ºä»¶: $(basename "$SYS_FILE")"
            echo "   å¤§å°: $(du -h "$SYS_FILE" | cut -f1)"
            echo "   MD5: $(md5sum "$SYS_FILE" | cut -d' ' -f1)"
            
            # éªŒè¯å›ºä»¶æ ¼å¼
            echo "ðŸ”¬ éªŒè¯å›ºä»¶æ ¼å¼..."
            if hexdump -C "$SYS_FILE" | head -5 | grep -q "OpenWrt"; then
              echo "   åŒ…å«OpenWrtæ ‡è¯†"
            fi
            
            # åˆ›å»ºå›ºä»¶ä¿¡æ¯æ–‡ä»¶
            cat > firmware-info.txt << 'INFO'
å›ºä»¶ä¿¡æ¯:
==========
æ–‡ä»¶å: $(basename "$SYS_FILE")
å¤§å°: $(du -h "$SYS_FILE" | cut -f1)
MD5: $(md5sum "$SYS_FILE" | cut -d' ' -f1)
SHA256: $(sha256sum "$SYS_FILE" | cut -d' ' -f1)
ç¼–è¯‘æ—¶é—´: $(date)
OpenWRTç‰ˆæœ¬: ${{ github.event.inputs.openwrt_version }}
åŒ…å«LuCI: ${{ github.event.inputs.with_luci }}
INFO
          else
            echo "âŒ æœªæ‰¾åˆ°sysupgradeå›ºä»¶"
            echo "å¯ç”¨æ–‡ä»¶:"
            find bin/targets -name "*.bin" -type f | head -10
          fi
        else
          echo "âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: bin/targets/ramips/mt7621"
          echo "å°è¯•æŸ¥æ‰¾å…¶ä»–ä½ç½®..."
          find . -name "*.bin" -type f | head -20
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: k2p-official-${{ github.event.inputs.openwrt_version }}-${{ github.run_number }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/*.bin
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/firmware-info.txt
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/sha256sums
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/config.buildinfo
        retention-days: 7
        if-no-files-found: error
    
    - name: Create summary
      if: always()
      run: |
        echo "## æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "- OpenWRTç‰ˆæœ¬: ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- åŒ…å«LuCI: ${{ github.event.inputs.with_luci }}" >> $GITHUB_STEP_SUMMARY
        echo "- ç¼–è¯‘çŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æžœæœ‰å›ºä»¶ä¿¡æ¯æ–‡ä»¶ï¼Œæ˜¾ç¤ºè¯¦æƒ…
        if [ -f "${{ github.workspace }}/openwrt/firmware-info.txt" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å›ºä»¶ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "${{ github.workspace }}/openwrt/firmware-info.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
