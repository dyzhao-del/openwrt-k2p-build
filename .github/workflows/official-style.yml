name: Build Official Style

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string
      config_type:
        description: 'Configuration type'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - with-luci

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time subversion libelf-dev
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "ðŸš€ Cloning OpenWRT $VERSION..."
        
        # æ¸…ç†ä¹‹å‰çš„æž„å»º
        rm -rf openwrt 2>/dev/null || true
        
        git clone https://github.com/openwrt/openwrt.git -b $VERSION
        cd openwrt
        echo "Commit: $(git log -1 --oneline)"
    
    - name: Configure for K2P
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ”§ Configuring for K2P..."
        echo "Using config type: ${{ github.event.inputs.config_type }}"
        
        # é€‰æ‹©é…ç½®æ–‡ä»¶
        CONFIG_FILE=""
        if [[ "${{ github.event.inputs.config_type }}" == "minimal" ]]; then
          CONFIG_FILE="../configs/k2p-minimal.config"
        elif [[ "${{ github.event.inputs.config_type }}" == "with-luci" ]]; then
          CONFIG_FILE="../configs/k2p-with-luci.config"
        fi
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "Using config file: $CONFIG_FILE"
          cp "$CONFIG_FILE" .config
        else
          echo "âš ï¸ Config file not found, using minimal defaults"
          # åŸºç¡€é…ç½®
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
          echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
          echo "CONFIG_PACKAGE_firewall=y" >> .config
          echo "CONFIG_PACKAGE_kmod-mt7615e=y" >> .config
        fi
        
        # è¿è¡Œdefconfigå¡«å……å…¶ä»–é…ç½®
        echo "Running defconfig..."
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "ðŸ“‹ Configuration summary:"
        echo "========================================"
        grep -E "^CONFIG_TARGET|^CONFIG_PACKAGE" .config | sort | head -30
        echo "========================================"
        
        # æ£€æŸ¥å…³é”®é…ç½®
        echo "ðŸ” Checking critical configs..."
        REQUIRED_CONFIGS=(
          "CONFIG_TARGET_ramips=y"
          "CONFIG_TARGET_ramips_mt7621=y"
          "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y"
        )
        
        for config in "${REQUIRED_CONFIGS[@]}"; do
          if grep -q "^$config$" .config; then
            echo "âœ… $(echo $config | cut -d'=' -f1)"
          else
            echo "âŒ MISSING: $(echo $config | cut -d'=' -f1)"
          fi
        done
    
    - name: Update feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ“¦ Updating feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "âœ… Feeds updated"
    
    - name: Download packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "â¬‡ï¸ Downloading packages..."
        
        # ç¡®ä¿dlç›®å½•å­˜åœ¨
        mkdir -p dl
        
        # å°è¯•å¹¶è¡Œä¸‹è½½ï¼Œå¦‚æžœå¤±è´¥åˆ™ä½¿ç”¨å•çº¿ç¨‹
        echo "Attempting parallel download..."
        make download -j$(nproc) || {
          echo "Parallel download failed, trying single-threaded..."
          make download
        }
        
        # æ£€æŸ¥ä¸‹è½½ç»“æžœ
        if [ -f "tmp/.package-download-errors" ]; then
          echo "âš ï¸ Some packages failed to download:"
          cat tmp/.package-download-errors
          echo "Will attempt to build anyway..."
        else
          echo "âœ… Package download completed"
        fi
    
    - name: Build firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ”¨ Starting firmware build..."
        START_TIME=$(date +%s)
        
        # è®¾ç½®å¹¶è¡Œç¼–è¯‘ä»»åŠ¡æ•°
        CPU_CORES=$(nproc)
        if [ $CPU_CORES -gt 4 ]; then
          JOBS=$((CPU_CORES - 2))
        elif [ $CPU_CORES -gt 2 ]; then
          JOBS=$((CPU_CORES - 1))
        else
          JOBS=2
        fi
        
        echo "Using $JOBS parallel jobs"
        echo "Build log: build.log"
        
        # å¼€å§‹ç¼–è¯‘
        set +e
        make -j$JOBS V=s 2>&1 | tee build.log
        BUILD_STATUS=$?
        set -e
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "â±ï¸ Build duration: $((DURATION / 60)) minutes $((DURATION % 60)) seconds"
        
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "âœ… Build successful!"
        else
          echo "âŒ Build failed"
          
          # æ˜¾ç¤ºæœ€åŽ50è¡Œæ—¥å¿—ä¸­çš„é”™è¯¯
          echo "Last 50 lines with errors:"
          tail -100 build.log | grep -i "error\|failed\|missing" | tail -20 || echo "No error patterns found"
          
          # æ£€æŸ¥å¸¸è§é—®é¢˜
          echo "Checking for common issues..."
          if grep -q "recipe for target" build.log; then
            echo "Found compilation errors"
          fi
          
          exit 1
        fi
    
    - name: Find and verify firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ” Looking for firmware files..."
        
        # æ£€æŸ¥ç›®æ ‡ç›®å½•
        TARGET_DIR="bin/targets/ramips/mt7621"
        if [ -d "$TARGET_DIR" ]; then
          echo "ðŸ“ Target directory found: $TARGET_DIR"
          echo "Contents:"
          ls -la "$TARGET_DIR/"
          
          # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
          FIRMWARE_FILES=$(find "$TARGET_DIR" -name "*.bin" -type f)
          if [ -n "$FIRMWARE_FILES" ]; then
            echo "ðŸŽ¯ Found firmware files:"
            for file in $FIRMWARE_FILES; do
              SIZE=$(du -h "$file" | cut -f1)
              echo "  - $(basename "$file") ($SIZE)"
            done
            
            # ç‰¹åˆ«æŸ¥æ‰¾sysupgradeå›ºä»¶
            SYS_FILE=$(find "$TARGET_DIR" -name "*sysupgrade*.bin" -type f | head -1)
            if [ -n "$SYS_FILE" ] && [ -f "$SYS_FILE" ]; then
              echo "âœ… Found sysupgrade firmware: $(basename "$SYS_FILE")"
              echo "   Size: $(du -h "$SYS_FILE" | cut -f1)"
              echo "   MD5: $(md5sum "$SYS_FILE" | cut -d' ' -f1)"
              
              # åˆ›å»ºå›ºä»¶ä¿¡æ¯
              cat > firmware-info.txt << 'INFO'
# Firmware Information
Filename: $(basename "$SYS_FILE")
Size: $(du -h "$SYS_FILE" | cut -f1)
MD5: $(md5sum "$SYS_FILE" | cut -d' ' -f1)
Build Time: $(date)
OpenWRT Version: ${{ github.event.inputs.openwrt_version }}
Config Type: ${{ github.event.inputs.config_type }}
INFO
            fi
          else
            echo "âŒ No .bin files found in target directory"
          fi
        else
          echo "âŒ Target directory not found: $TARGET_DIR"
          echo "Searching for bin files elsewhere..."
          find . -name "*.bin" -type f | head -10
        fi
    
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: k2p-${{ github.event.inputs.openwrt_version }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/firmware-info.txt
        retention-days: 7
    
    - name: Create build summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**OpenWRT Version:** ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Config Type:** ${{ github.event.inputs.config_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **Build Successful**" >> $GITHUB_STEP_SUMMARY
          
          # å¦‚æžœæœ‰å›ºä»¶ä¿¡æ¯ï¼Œæ˜¾ç¤º
          if [ -f "${{ github.workspace }}/openwrt/firmware-info.txt" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Firmware Information" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "${{ github.workspace }}/openwrt/firmware-info.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Build Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the build log for details." >> $GITHUB_STEP_SUMMARY
        fi
