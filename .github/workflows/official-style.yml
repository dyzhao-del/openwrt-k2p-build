name: Build Official Style

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string
      config_type:
        description: 'Configuration type'
        required: true
        default: 'basic-enhanced'
        type: choice
        options:
          - minimal
          - basic-enhanced
          - advanced
          - stable

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time subversion libelf-dev gperf unzip
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "Cloning OpenWRT $VERSION..."
        
        rm -rf openwrt 2>/dev/null || true
        git clone https://github.com/openwrt/openwrt.git -b $VERSION
        cd openwrt
        echo "Commit: $(git log -1 --oneline)"
    
    - name: Configure for K2P
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Configuring for K2P..."
        echo "Using config type: ${{ github.event.inputs.config_type }}"
        
        # 根据配置类型选择文件
        case "${{ github.event.inputs.config_type }}" in
          "minimal")
            CONFIG_FILE="../configs/k2p-minimal.config"
            ;;
          "basic-enhanced")
            CONFIG_FILE="../configs/k2p-basic-enhanced.config"
            ;;
          "advanced")
            CONFIG_FILE="../configs/k2p-advanced.config"
            ;;
          "stable")
            CONFIG_FILE="../configs/k2p-stable.config"
            ;;
          *)
            CONFIG_FILE="../configs/k2p-minimal.config"
            ;;
        esac
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "Using config file: $CONFIG_FILE"
          cp "$CONFIG_FILE" .config
          
          # 显示配置信息
          echo "Selected packages:"
          grep -c "^CONFIG_PACKAGE" "$CONFIG_FILE" || echo "No package count"
        else
          echo "Config file not found: $CONFIG_FILE"
          echo "Using minimal defaults"
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config
        fi
        
        make defconfig
        
        echo "Configuration summary:"
        echo "======================"
        grep "^CONFIG_TARGET" .config
        echo ""
        echo "Total packages selected:"
        grep -c "^CONFIG_PACKAGE" .config || echo "0"
    
    - name: Update feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Updating feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds updated"
    
    - name: Download packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Downloading packages..."
        mkdir -p dl
        
        # 尝试下载，失败则继续
        make download -j$(nproc) || make download || true
        
        echo "Download attempt completed"
    
    - name: Build firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Starting firmware build..."
        START_TIME=$(date +%s)
        
        CPU_CORES=$(nproc)
        if [ $CPU_CORES -gt 4 ]; then
          JOBS=$((CPU_CORES - 2))
        elif [ $CPU_CORES -gt 2 ]; then
          JOBS=$((CPU_CORES - 1))
        else
          JOBS=2
        fi
        
        echo "Using $JOBS parallel jobs"
        
        # 编译，忽略部分错误
        set +e
        make -j$JOBS V=s 2>&1 | tee build.log
        BUILD_STATUS=$?
        set -e
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "Build duration: $((DURATION / 60)) minutes $((DURATION % 60)) seconds"
        
        # 检查是否生成了固件文件
        if [ -f "bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin" ]; then
          echo "✅ Firmware generated successfully!"
          echo "File size: $(du -h bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin | cut -f1)"
        elif [ $BUILD_STATUS -eq 0 ]; then
          echo "⚠️ Build completed but firmware not found"
        else
          echo "❌ Build failed"
          tail -50 build.log | grep -i "error\|failed" || echo "Check build.log for details"
          exit 1
        fi
    
    - name: Collect firmware info
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Collecting firmware information..."
        
        FIRMWARE_FILE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
        
        if [ -f "$FIRMWARE_FILE" ]; then
          echo "Creating firmware-info.txt"
          echo "# K2P OpenWRT Firmware" > firmware-info.txt
          echo "Build Date: $(date)" >> firmware-info.txt
          echo "OpenWRT Version: ${{ github.event.inputs.openwrt_version }}" >> firmware-info.txt
          echo "Config Type: ${{ github.event.inputs.config_type }}" >> firmware-info.txt
          echo "Firmware: $(basename $FIRMWARE_FILE)" >> firmware-info.txt
          echo "Size: $(du -h $FIRMWARE_FILE | cut -f1)" >> firmware-info.txt
          echo "MD5: $(md5sum $FIRMWARE_FILE | cut -d' ' -f1)" >> firmware-info.txt
          
          # 列出包含的主要包
          echo "" >> firmware-info.txt
          echo "## Main Features:" >> firmware-info.txt
          grep "^CONFIG_PACKAGE_luci" .config | sed 's/CONFIG_PACKAGE_//g' | head -10 >> firmware-info.txt
        fi
    
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: k2p-${{ github.event.inputs.openwrt_version }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/firmware-info.txt
        retention-days: 7
    
    - name: Create summary
      if: always()
      run: |
        echo "## K2P OpenWRT Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**OpenWRT Version:** ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:** ${{ github.event.inputs.config_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ **Build Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Firmware should be available in the artifacts." >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Build Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the build log for error details." >> $GITHUB_STEP_SUMMARY
        fi
