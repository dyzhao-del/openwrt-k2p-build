name: Build Smart

on:
  workflow_dispatch:
    inputs:
      config_level:
        description: 'Configuration level'
        required: true
        default: 'webui'
        type: choice
        options:
          - 'minimal'
          - 'webui'
          - 'extended'
      openwrt_version:
        description: 'OpenWRT version'
        required: false
        default: 'v23.05.3'

jobs:
  smart-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache file g++ gawk gettext git \
          libncurses5-dev libncursesw5-dev libssl-dev python3 \
          rsync unzip wget zlib1g-dev
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        git clone https://github.com/openwrt/openwrt.git --branch ${{ github.event.inputs.openwrt_version }} --depth=1
        echo "OpenWRT ${{ github.event.inputs.openwrt_version }} cloned"
    
    - name: Select configuration
      id: select-config
      run: |
        CONFIG_LEVEL="${{ github.event.inputs.config_level }}"
        
        case "$CONFIG_LEVEL" in
          "minimal")
            CONFIG_FILE="k2p-reliable.config"
            ;;
          "webui")
            CONFIG_FILE="k2p-with-webui.config"
            ;;
          "extended")
            CONFIG_FILE="k2p-full-extended.config"
            ;;
          *)
            CONFIG_FILE="k2p-reliable.config"
            ;;
        esac
        
        echo "Selected config: $CONFIG_FILE"
        echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "configs/$CONFIG_FILE" ]; then
          echo "Error: Config file not found: $CONFIG_FILE"
          exit 1
        fi
    
    - name: Apply and build
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Applying configuration: ${{ steps.select-config.outputs.CONFIG_FILE }}"
        cp "$GITHUB_WORKSPACE/configs/${{ steps.select-config.outputs.CONFIG_FILE }}" .config
        
        # å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
        make defconfig
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "Downloading packages..."
        make download -j2 || make download -j1
        
        echo "Starting compilation..."
        make -j2 V=s 2>&1 | tee build.log
        
    - name: Analyze result
      if: success()
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ“Š Build Analysis"
        echo "================="
        
        # æŸ¥æ‰¾å›ºä»¶
        FIRMWARE=$(find . -name "*phicomm_k2p*.bin" -type f | head -1)
        
        if [ -z "$FIRMWARE" ]; then
          echo "âŒ No K2P firmware found"
          exit 1
        fi
        
        # è®¡ç®—å¤§å°
        SIZE_BYTES=$(stat -c%s "$FIRMWARE")
        SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc)
        MAX_MB=16
        REMAINING_MB=$(echo "scale=2; $MAX_MB - $SIZE_MB" | bc)
        
        echo "Firmware: $(basename $FIRMWARE)"
        echo "Size: ${SIZE_MB}MB"
        echo "Limit: ${MAX_MB}MB"
        echo "Remaining: ${REMAINING_MB}MB"
        
        # å»ºè®®
        if (( $(echo "$SIZE_MB > 15" | bc -l) )); then
          echo "âš ï¸  Warning: FirmwareæŽ¥è¿‘å®¹é‡ä¸Šé™"
          echo "å»ºè®®ï¼šç§»é™¤ä¸€äº›éžæ ¸å¿ƒåŒ…"
        elif (( $(echo "$SIZE_MB > 10" | bc -l) )); then
          echo "âš ï¸  æ³¨æ„ï¼šè¿˜æœ‰ç©ºé—´æ·»åŠ æ›´å¤šåŠŸèƒ½"
          echo "å‰©ä½™ç©ºé—´çº¦: ${REMAINING_MB}MB"
        else
          echo "âœ… è‰¯å¥½ï¼šå……è¶³çš„ç©ºé—´å¯ç”¨äºŽæ‰©å±•"
          echo "å¯æ·»åŠ çº¦: ${REMAINING_MB}MB çš„é¢å¤–åŠŸèƒ½"
        fi
        
        # ä¿å­˜åˆ†æžç»“æžœ
        echo "BUILD_LEVEL=${{ github.event.inputs.config_level }}" >> $GITHUB_ENV
        echo "FIRMWARE_SIZE_MB=$SIZE_MB" >> $GITHUB_ENV
        echo "REMAINING_SPACE_MB=$REMAINING_MB" >> $GITHUB_ENV
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ steps.select-config.outputs.CONFIG_FILE }}-${{ github.run_number }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/**
          ${{ github.workspace }}/openwrt/.config
        retention-days: 14
    
    - name: Create summary
      if: success()
      run: |
        echo "# Build Summary" > summary.md
        echo "## Configuration: ${{ env.BUILD_LEVEL }}" >> summary.md
        echo "### Firmware Size: ${{ env.FIRMWARE_SIZE_MB }}MB" >> summary.md
        echo "### Remaining Space: ${{ env.REMAINING_SPACE_MB }}MB" >> summary.md
        echo "" >> summary.md
        echo "### Recommendations:" >> summary.md
        
        if (( $(echo "${{ env.REMAINING_SPACE_MB }} > 3" | bc -l) )); then
          echo "- âœ… å¯ä»¥æ·»åŠ æ›´å¤šåŠŸèƒ½ (Luciåº”ç”¨ã€å·¥å…·ç­‰)" >> summary.md
        elif (( $(echo "${{ env.REMAINING_SPACE_MB }} > 1" | bc -l) )); then
          echo "- âš ï¸  ç©ºé—´æœ‰é™ï¼Œåªèƒ½æ·»åŠ å°‘é‡åŠŸèƒ½" >> summary.md
        else
          echo "- âŒ ç©ºé—´ä¸è¶³ï¼Œéœ€è¦ç²¾ç®€çŽ°æœ‰åŠŸèƒ½" >> summary.md
        fi
        
        cat summary.md
