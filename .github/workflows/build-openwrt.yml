name: Build OpenWRT for Phicomm K2P

on:
  workflow_dispatch:
    inputs:
      build_stage:
        description: 'Build Stage (1, 2, or 3)'
        required: true
        default: '2'
        type: choice
        options:
        - '1'
        - '2'
        - '3'
  
  push:
    branches: [main]
    paths:
    - 'configs/**'
    - '.github/workflows/**'

env:
  OPENWRT_VERSION: "v23.05.3"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-setuptools python3-pip \
          rsync subversion swig time unzip wget xsltproc zlib1g-dev
        
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        git clone https://github.com/openwrt/openwrt.git -b ${{ env.OPENWRT_VERSION }} --depth=1
        
    - name: Cache packages
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ env.OPENWRT_VERSION }}
        
    - name: Update feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Apply configuration
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        if [ "${{ github.event.inputs.build_stage }}" = "1" ]; then
          CONFIG_FILE="k2p-minimal.config"
        elif [ "${{ github.event.inputs.build_stage }}" = "2" ]; then
          CONFIG_FILE="k2p-stage2-extended.config"
        elif [ "${{ github.event.inputs.build_stage }}" = "3" ]; then
          CONFIG_FILE="k2p-stage3-advanced.config"
        else
          CONFIG_FILE="k2p-stage2-extended.config"
        fi
        
        echo "Using config file: $CONFIG_FILE"
        
        if [ -f "$GITHUB_WORKSPACE/configs/$CONFIG_FILE" ]; then
          cp "$GITHUB_WORKSPACE/configs/$CONFIG_FILE" .config
          make defconfig
        else
          echo "Error: Config file not found"
          exit 1
        fi
        
    - name: Download packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        make download -j$(nproc) || make download -j1
        
    - name: Build firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
    - name: Check firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        FIRMWARE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
        
        if [ -f "$FIRMWARE" ]; then
          echo "Firmware built successfully!"
          ls -lh bin/targets/ramips/mt7621/
        else
          echo "Firmware not found!"
          exit 1
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/*
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: ${{ github.workspace }}/openwrt/build.log
