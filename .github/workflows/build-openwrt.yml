name: Build OpenWRT for Phicomm K2P

on:
  workflow_dispatch:
    inputs:
      build_stage:
        description: 'Build Stage (1=Minimal, 2=Extended, 3=Advanced)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      clean_build:
        description: 'Clean build (ignore cache)'
        required: false
        default: false
        type: boolean
  
  push:
    branches: [main, master]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/**'

  # å®šæ—¶æ„å»ºï¼ˆé»˜è®¤ä½¿ç”¨é˜¶æ®µ2ï¼‰
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥åˆå¤œ

env:
  OPENWRT_VERSION: "v23.05.3"
  DEVICE_NAME: "phicomm_k2p"
  # é»˜è®¤æ„å»ºé˜¶æ®µï¼ˆç”¨äºéæ‰‹åŠ¨è§¦å‘ï¼‰
  DEFAULT_BUILD_STAGE: "2"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240  # 4å°æ—¶ï¼Œé˜¶æ®µ2éœ€è¦æ›´å¤šæ—¶é—´
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-setuptools python3-pip \
          rsync subversion swig time unzip wget xsltproc zlib1g-dev \
          python3-pyelftools cmake python3-dev p7zip-full jq lzma cpio
        
    - name: Clone OpenWRT Source
      run: |
        cd $GITHUB_WORKSPACE
        git clone https://github.com/openwrt/openwrt.git -b ${{ env.OPENWRT_VERSION }} --depth=1
        cd openwrt
        
    - name: Setup Build Cache
      if: ${{ !github.event.inputs.clean_build }}
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/openwrt/dl
          /tmp/ccache
        key: ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-${{ env.DEFAULT_BUILD_STAGE }}-${{ hashFiles('configs/device-phicomm_k2p.yml') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-${{ env.DEFAULT_BUILD_STAGE }}-
          ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-
          
    - name: Setup ccache
      run: |
        ccache -o max_size=15G
        ccache -s
        
    - name: Update Feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Apply Configuration Based on Stage
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        # ç¡®å®šæ„å»ºé˜¶æ®µ
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å‚æ•°
          BUILD_STAGE="${{ github.event.inputs.build_stage }}"
        else
          # è‡ªåŠ¨è§¦å‘æ—¶ä½¿ç”¨é»˜è®¤é˜¶æ®µ
          BUILD_STAGE="${{ env.DEFAULT_BUILD_STAGE }}"
        fi
        
        echo "ğŸ”§ Build stage determined: $BUILD_STAGE"
        echo "ğŸ”§ Triggered by: ${{ github.event_name }}"
        
        # æ ¹æ®é€‰æ‹©çš„é˜¶æ®µåº”ç”¨é…ç½®
        CONFIG_FILE=""
        
        case "$BUILD_STAGE" in
          "1")
            CONFIG_FILE="k2p-minimal.config"
            echo "ğŸ”§ Applying Stage 1 (Minimal) configuration"
            ;;
          "2")
            CONFIG_FILE="k2p-stage2-extended.config"
            echo "ğŸ”§ Applying Stage 2 (Extended) configuration"
            ;;
          "3")
            CONFIG_FILE="k2p-stage3-advanced.config"
            echo "ğŸ”§ Applying Stage 3 (Advanced) configuration"
            ;;
          *)
            echo "âŒ Unknown build stage: $BUILD_STAGE"
            echo "Available stages: 1, 2, 3"
            echo "Using default stage: ${{ env.DEFAULT_BUILD_STAGE }}"
            
            # ä½¿ç”¨é»˜è®¤é˜¶æ®µä½œä¸ºåå¤‡
            if [ "${{ env.DEFAULT_BUILD_STAGE }}" == "1" ]; then
              CONFIG_FILE="k2p-minimal.config"
            elif [ "${{ env.DEFAULT_BUILD_STAGE }}" == "2" ]; then
              CONFIG_FILE="k2p-stage2-extended.config"
            else
              CONFIG_FILE="k2p-stage3-advanced.config"
            fi
            echo "ğŸ”§ Using default configuration: $CONFIG_FILE"
            ;;
        esac
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$GITHUB_WORKSPACE/configs/$CONFIG_FILE" ]; then
          echo "âŒ Configuration file not found: $CONFIG_FILE"
          echo "Available config files:"
          ls -la "$GITHUB_WORKSPACE/configs/"
          exit 1
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        echo "ğŸ“‹ Copying configuration file: $CONFIG_FILE"
        cp "$GITHUB_WORKSPACE/configs/$CONFIG_FILE" .config
        
        # æ£€æŸ¥.configæ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ ! -f ".config" ]; then
          echo "âŒ Failed to create .config file"
          exit 1
        fi
        
        echo "ğŸ“„ .config file created successfully"
        echo "First 10 lines of .config:"
        head -10 .config
        
        # ç”Ÿæˆå®Œæ•´é…ç½®
        echo "ğŸ”„ Running defconfig..."
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "ğŸ“Š Configuration summary:"
        echo "=========================="
        TOTAL_PACKAGES=$(grep "^CONFIG_PACKAGE" .config | grep "=y$" | wc -l)
        echo "Total packages enabled: $TOTAL_PACKAGES"
        
        # æ˜¾ç¤ºå¯ç”¨çš„åŒ…åˆ†ç±»
        echo ""
        echo "ğŸ“¦ Enabled packages by category:"
        echo "-------------------------------"
        grep "^CONFIG_PACKAGE.*=y$" .config | \
          sed 's/CONFIG_PACKAGE_//;s/=y$//' | \
          sort | \
          awk '
            /luci/ {luci++}
            /kmod/ {kmod++}
            /^[a-z]/ && !/luci/ && !/kmod/ {other++}
            END {
              printf "Webç•Œé¢ (luci-*): %d\n", luci
              printf "å†…æ ¸æ¨¡å— (kmod-*): %d\n", kmod
              printf "å…¶ä»–å·¥å…·: %d\n", other
            }
          '
        
    - name: Download Packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "ğŸ“¦ Downloading packages..."
        make download -j$(nproc) || make download -j1
        
        # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
        if [ $? -eq 0 ]; then
          echo "âœ… Package download completed"
        else
          echo "âš ï¸ Package download had issues, but continuing..."
        fi
        
    - name: Build Firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        cat > build-info.txt << BUILDINFO
Build Information
=================
Stage: $BUILD_STAGE
OpenWRT Version: ${{ env.OPENWRT_VERSION }}
Device: ${{ env.DEVICE_NAME }}
GitHub Run ID: ${{ github.run_id }}
Commit SHA: ${{ github.sha }}
Build Date: $(date)
Trigger: ${{ github.event_name }}
BUILDINFO
        
        echo "ğŸ”¨ Building firmware..."
        echo "Build stage: $BUILD_STAGE"
        
        # å¼€å§‹ç¼–è¯‘ï¼Œä¿å­˜è¯¦ç»†æ—¥å¿—
        BUILD_START=$(date +%s)
        
        # ä½¿ç”¨teeåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶
        # è®¾ç½®ç®¡é“é”™è¯¯å¤„ç†
        set -o pipefail
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        BUILD_EXIT_CODE=$?
        set +o pipefail
        
        BUILD_END=$(date +%s)
        BUILD_DURATION=$((BUILD_END - BUILD_START))
        
        echo "Build duration: $((BUILD_DURATION / 60))m $((BUILD_DURATION % 60))s" >> build-info.txt
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… Build completed successfully!"
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ Build failed with exit code: $BUILD_EXIT_CODE"
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          
          # æ£€æŸ¥å¸¸è§é”™è¯¯
          echo "ğŸ” Checking for common errors..."
          if grep -q "package size exceeds" build.log; then
            echo "âŒ Firmware too large! Need to reduce package size."
          fi
          if grep -q "download failed" build.log; then
            echo "âŒ Package download failed! Network issue."
          fi
          if grep -q "dependency error" build.log; then
            echo "âŒ Package dependency error!"
          fi
        fi
        
    - name: Check Build Result
      if: ${{ env.BUILD_STATUS == 'success' }}
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
        FIRMWARE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
        
        if [ -f "$FIRMWARE" ]; then
          echo "âœ… Firmware built successfully!"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“ Output directory contents:"
          ls -lh bin/targets/ramips/mt7621/
          
          # æ£€æŸ¥å›ºä»¶å¤§å°
          FIRMWARE_SIZE=$(stat -c%s "$FIRMWARE")
          MAX_SIZE=$((16 * 1024 * 1024))  # 16MB
          
          echo ""
          echo "ğŸ“Š Firmware size check:"
          echo "  Current size: $((FIRMWARE_SIZE / 1024 / 1024))MB"
          echo "  Maximum size: $((MAX_SIZE / 1024 / 1024))MB"
          echo "  Available: $(( (MAX_SIZE - FIRMWARE_SIZE) / 1024 ))KB"
          
          if [ $FIRMWARE_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ ERROR: Firmware too large! Exceeds 16MB limit."
            echo "Please remove some packages and try again."
            
            # æ˜¾ç¤ºæœ€å¤§çš„åŒ…
            echo ""
            echo "ğŸ“¦ Largest packages (consider removing):"
            find bin/targets/ramips/mt7621 -name "*.ipk" -exec du -h {} \; | sort -hr | head -10
            
            exit 1
          else
            echo "âœ… Firmware size is within limits."
          fi
          
          # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
          cd bin/targets/ramips/mt7621
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          
          # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
          echo ""
          echo "ğŸ“‹ Build information:"
          cat $GITHUB_WORKSPACE/openwrt/build-info.txt
          
        else
          echo "âŒ ERROR: Firmware file not found!"
          echo "Available files in output directory:"
          find bin/targets/ -type f 2>/dev/null | head -20 || echo "No output directory found"
          
          # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯
          echo ""
          echo "ğŸ” Last 20 lines of build log:"
          tail -20 $GITHUB_WORKSPACE/openwrt/build.log
          
          exit 1
        fi
        
    - name: Upload Artifacts
      if: ${{ env.BUILD_STATUS == 'success' }}
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-k2p-stage${{ env.DEFAULT_BUILD_STAGE }}-${{ github.run_number }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/*
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build-info.txt
        retention-days: 30
        
    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/logs/
        retention-days: 7
        
    - name: Save Cache
      if: ${{ env.BUILD_STATUS == 'success' && !github.event.inputs.clean_build }}
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/openwrt/dl
          /tmp/ccache
        key: ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-${{ env.DEFAULT_BUILD_STAGE }}-${{ hashFiles('configs/device-phicomm_k2p.yml') }}-${{ github.run_id }}
        
    - name: Create GitHub Release (Optional)
      if: ${{ env.BUILD_STATUS == 'success' && github.event_name == 'workflow_dispatch' }}
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: stage${{ github.event.inputs.build_stage || env.DEFAULT_BUILD_STAGE }}-${{ github.run_number }}
        name: "OpenWRT K2P Stage ${{ github.event.inputs.build_stage || env.DEFAULT_BUILD_STAGE }} Build #${{ github.run_number }}"
        body: |
          # OpenWRTå›ºä»¶ for Phicomm K2P
          
          **æ„å»ºä¿¡æ¯:**
          - é˜¶æ®µ: ${{ github.event.inputs.build_stage || env.DEFAULT_BUILD_STAGE }}
          - OpenWRTç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}
          - æ„å»ºæ—¥æœŸ: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - GitHubè¿è¡ŒID: ${{ github.run_id }}
          - æäº¤: ${{ github.sha }}
          
          **åŠŸèƒ½ç‰¹æ€§:**
          ${{ github.event.inputs.build_stage == '1' || env.DEFAULT_BUILD_STAGE == '1' && '- æœ€å°ç³»ç»Ÿï¼ˆä»…åŸºç¡€è·¯ç”±åŠŸèƒ½ï¼‰' || '' }}
          ${{ github.event.inputs.build_stage == '2' || env.DEFAULT_BUILD_STAGE == '2' && '- Webç®¡ç†ç•Œé¢ï¼ˆLuciï¼‰\n- å¸¸ç”¨ç³»ç»Ÿå·¥å…·\n- ç½‘ç»œè¯Šæ–­å·¥å…·\n- QoSå’Œæµé‡æ§åˆ¶\n- å¸¦å®½ç›‘æ§' || '' }}
          ${{ github.event.inputs.build_stage == '3' || env.DEFAULT_BUILD_STAGE == '3' && '- VPNæ”¯æŒ\n- NASåŠŸèƒ½\n- å¹¿å‘Šè¿‡æ»¤\n- é«˜çº§ç½‘ç»œåŠŸèƒ½' || '' }}
          
          **å®‰è£…è¯´æ˜:**
          1. ä¸‹è½½å¯¹åº”çš„.binæ–‡ä»¶
          2. ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢
          3. é€‰æ‹©å›ºä»¶å‡çº§
          4. ä¸Šä¼ å¹¶åˆ·å…¥å›ºä»¶
          5. ç­‰å¾…è‡ªåŠ¨é‡å¯
          
          **é»˜è®¤ç™»å½•:**
          - åœ°å€: 192.168.1.1
          - ç”¨æˆ·å: root
          - å¯†ç : (é¦–æ¬¡ç™»å½•æ—¶è®¾ç½®)
          
          **æ³¨æ„äº‹é¡¹:**
          - åˆ·æœºå‰è¯·å¤‡ä»½åŸå‚å›ºä»¶
          - ç¡®ä¿å›ºä»¶å¤§å°ä¸è¶…è¿‡16MB
          - å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
        draft: false
        prerelease: false
        files: ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/*
