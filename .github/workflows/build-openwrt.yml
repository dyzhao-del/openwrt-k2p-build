name: Build OpenWRT for Phicomm K2P

on:
  workflow_dispatch:
    inputs:
      build_stage:
        description: 'Build Stage (1=Minimal, 2=Extended, 3=Advanced)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      clean_build:
        description: 'Clean build (ignore cache)'
        required: false
        default: false
        type: boolean
  
  push:
    branches: [main, master]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/**'

env:
  OPENWRT_VERSION: "v23.05.3"
  DEVICE_NAME: "phicomm_k2p"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240  # 4å°æ—¶ï¼Œé˜¶æ®µ2éœ€è¦æ›´å¤šæ—¶é—´
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-setuptools python3-pip \
          rsync subversion swig time unzip wget xsltproc zlib1g-dev \
          python3-pyelftools cmake python3-dev p7zip-full jq lzma cpio
        
    - name: Clone OpenWRT Source
      run: |
        cd $GITHUB_WORKSPACE
        git clone https://github.com/openwrt/openwrt.git -b ${{ env.OPENWRT_VERSION }} --depth=1
        cd openwrt
        
    - name: Setup Build Cache
      if: ${{ !github.event.inputs.clean_build }}
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/openwrt/dl
          /tmp/ccache
        key: ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-${{ github.event.inputs.build_stage }}-${{ hashFiles('configs/device-phicomm_k2p.yml') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-${{ github.event.inputs.build_stage }}-
          ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-
          
    - name: Setup ccache
      run: |
        ccache -o max_size=15G
        ccache -s
        
    - name: Update Feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Apply Configuration Based on Stage
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        # æ ¹æ®é€‰æ‹©çš„é˜¶æ®µåº”ç”¨é…ç½®
        BUILD_STAGE="${{ github.event.inputs.build_stage }}"
        CONFIG_FILE=""
        
        case "$BUILD_STAGE" in
          "1")
            CONFIG_FILE="k2p-minimal.config"
            echo "ğŸ”§ Applying Stage 1 (Minimal) configuration"
            ;;
          "2")
            CONFIG_FILE="k2p-stage2-extended.config"
            echo "ğŸ”§ Applying Stage 2 (Extended) configuration"
            ;;
          "3")
            CONFIG_FILE="k2p-stage3-advanced.config"
            echo "ğŸ”§ Applying Stage 3 (Advanced) configuration"
            ;;
          *)
            echo "âŒ Unknown build stage: $BUILD_STAGE"
            exit 1
            ;;
        esac
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp "$GITHUB_WORKSPACE/configs/$CONFIG_FILE" .config
        
        # ç”Ÿæˆå®Œæ•´é…ç½®
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "ğŸ“Š Configuration summary:"
        echo "=========================="
        grep "^CONFIG_PACKAGE" .config | grep "=y$" | wc -l | xargs echo "Total packages enabled: "
        echo ""
        
    - name: Download Packages
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "ğŸ“¦ Downloading packages..."
        make download -j$(nproc) || make download -j1
        
    - name: Build Firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        echo "Build Information" > build-info.txt
        echo "=================" >> build-info.txt
        echo "Stage: ${{ github.event.inputs.build_stage }}" >> build-info.txt
        echo "OpenWRT Version: ${{ env.OPENWRT_VERSION }}" >> build-info.txt
        echo "Device: ${{ env.DEVICE_NAME }}" >> build-info.txt
        echo "GitHub Run ID: ${{ github.run_id }}" >> build-info.txt
        echo "Commit SHA: ${{ github.sha }}" >> build-info.txt
        echo "Build Date: $(date)" >> build-info.txt
        
        echo "ğŸ”¨ Building firmware..."
        
        # å¼€å§‹ç¼–è¯‘ï¼Œä¿å­˜è¯¦ç»†æ—¥å¿—
        BUILD_START=$(date +%s)
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        BUILD_EXIT_CODE=$?
        BUILD_END=$(date +%s)
        BUILD_DURATION=$((BUILD_END - BUILD_START))
        
        echo "Build duration: $((BUILD_DURATION / 60))m $((BUILD_DURATION % 60))s" >> build-info.txt
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… Build completed successfully!"
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ Build failed with exit code: $BUILD_EXIT_CODE"
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
        fi
        
    - name: Check Build Result
      if: ${{ env.BUILD_STATUS == 'success' }}
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
        FIRMWARE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
        
        if [ -f "$FIRMWARE" ]; then
          echo "âœ… Firmware built successfully!"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“ Output directory contents:"
          ls -lh bin/targets/ramips/mt7621/
          
          # æ£€æŸ¥å›ºä»¶å¤§å°
          FIRMWARE_SIZE=$(stat -c%s "$FIRMWARE")
          MAX_SIZE=$((16 * 1024 * 1024))  # 16MB
          
          echo ""
          echo "ğŸ“Š Firmware size check:"
          echo "  Current size: $((FIRMWARE_SIZE / 1024 / 1024))MB"
          echo "  Maximum size: $((MAX_SIZE / 1024 / 1024))MB"
          echo "  Available: $(( (MAX_SIZE - FIRMWARE_SIZE) / 1024 ))KB"
          
          if [ $FIRMWARE_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ ERROR: Firmware too large! Exceeds 16MB limit."
            echo "Please remove some packages and try again."
            exit 1
          else
            echo "âœ… Firmware size is within limits."
          fi
          
          # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
          cd bin/targets/ramips/mt7621
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          
          # æ˜¾ç¤ºå¯ç”¨çš„åŒ…æ•°é‡
          echo ""
          echo "ğŸ“¦ Packages enabled: $(grep "^CONFIG_PACKAGE" $GITHUB_WORKSPACE/openwrt/.config | grep "=y$" | wc -l)"
          
        else
          echo "âŒ ERROR: Firmware file not found!"
          echo "Available files in output directory:"
          find bin/targets/ -type f | head -20
          exit 1
        fi
        
    - name: Upload Artifacts
      if: ${{ env.BUILD_STATUS == 'success' }}
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-k2p-stage${{ github.event.inputs.build_stage }}-${{ github.run_number }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/*
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build-info.txt
        retention-days: 30
        
    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-stage${{ github.event.inputs.build_stage }}-${{ github.run_number }}
        path: |
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/logs/
        retention-days: 7
        
    - name: Save Cache
      if: ${{ env.BUILD_STATUS == 'success' && !github.event.inputs.clean_build }}
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/openwrt/dl
          /tmp/ccache
        key: ${{ runner.os }}-openwrt-${{ env.OPENWRT_VERSION }}-${{ github.event.inputs.build_stage }}-${{ hashFiles('configs/device-phicomm_k2p.yml') }}-${{ github.run_id }}
        
    - name: Create GitHub Release (Optional)
      if: ${{ env.BUILD_STATUS == 'success' && github.event_name == 'workflow_dispatch' }}
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: stage${{ github.event.inputs.build_stage }}-${{ github.run_number }}
        name: "OpenWRT K2P Stage ${{ github.event.inputs.build_stage }} Build #${{ github.run_number }}"
        body: |
          # OpenWRTå›ºä»¶ for Phicomm K2P
          
          **æ„å»ºä¿¡æ¯:**
          - é˜¶æ®µ: ${{ github.event.inputs.build_stage }}
          - OpenWRTç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}
          - æ„å»ºæ—¥æœŸ: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - GitHubè¿è¡ŒID: ${{ github.run_id }}
          - æäº¤: ${{ github.sha }}
          
          **åŠŸèƒ½ç‰¹æ€§:**
          ${{ github.event.inputs.build_stage == '1' && '- æœ€å°ç³»ç»Ÿï¼ˆä»…åŸºç¡€è·¯ç”±åŠŸèƒ½ï¼‰' || '' }}
          ${{ github.event.inputs.build_stage == '2' && '- Webç®¡ç†ç•Œé¢ï¼ˆLuciï¼‰\n- å¸¸ç”¨ç³»ç»Ÿå·¥å…·\n- ç½‘ç»œè¯Šæ–­å·¥å…·\n- QoSå’Œæµé‡æ§åˆ¶\n- å¸¦å®½ç›‘æ§' || '' }}
          ${{ github.event.inputs.build_stage == '3' && '- VPNæ”¯æŒ\n- NASåŠŸèƒ½\n- å¹¿å‘Šè¿‡æ»¤\n- é«˜çº§ç½‘ç»œåŠŸèƒ½' || '' }}
          
          **å®‰è£…è¯´æ˜:**
          1. ä¸‹è½½å¯¹åº”çš„.binæ–‡ä»¶
          2. ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢
          3. é€‰æ‹©å›ºä»¶å‡çº§
          4. ä¸Šä¼ å¹¶åˆ·å…¥å›ºä»¶
          5. ç­‰å¾…è‡ªåŠ¨é‡å¯
          
          **é»˜è®¤ç™»å½•:**
          - åœ°å€: 192.168.1.1
          - ç”¨æˆ·å: root
          - å¯†ç : (é¦–æ¬¡ç™»å½•æ—¶è®¾ç½®)
          
          **æ³¨æ„äº‹é¡¹:**
          - åˆ·æœºå‰è¯·å¤‡ä»½åŸå‚å›ºä»¶
          - ç¡®ä¿å›ºä»¶å¤§å°ä¸è¶…è¿‡16MB
          - å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
        draft: false
        prerelease: false
        files: ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/*
