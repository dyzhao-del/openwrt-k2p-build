name: Fix K2P Build

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string

jobs:
  fix-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "Cloning OpenWRT $VERSION..."
        
        rm -rf openwrt 2>/dev/null || true
        git clone https://github.com/openwrt/openwrt.git -b $VERSION --depth=1
    
    - name: Apply fixed config
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Applying fixed configuration..."
        
        # ä½¿ç”¨echoå‘½ä»¤é¿å…heredocçš„YAMLè§£æžé—®é¢˜
        echo "CONFIG_TARGET_ramips=y" > .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7615e=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7615-firmware=y" >> .config
        echo "CONFIG_PACKAGE_wpad-openssl=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        
        make defconfig
        
        echo "Configuration validation:"
        echo "========================="
        echo "Target device:"
        grep "CONFIG_TARGET.*DEVICE.*k2p" .config || echo "âš ï¸ K2P device not found!"
        
        echo ""
        echo "DNS server:"
        grep "CONFIG_PACKAGE_dnsmasq" .config || echo "âš ï¸ No DNS server configured!"
        
        echo ""
        echo "Total packages: $(grep -c '^CONFIG_PACKAGE' .config)"
    
    - name: Build with fixed config
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Starting firmware build..."
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ä¸‹è½½åŒ…
        make download -j2
        
        # å®Œæ•´æž„å»º
        make -j2 V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥ç»“æžœ
        if [ $? -eq 0 ]; then
          echo "âœ… Build successful!"
          
          # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
          if [ -f "bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin" ]; then
            FIRMWARE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
            echo "ðŸŽ¯ Firmware generated successfully!"
            echo "File: $(basename $FIRMWARE)"
            echo "Size: $(du -h $FIRMWARE | cut -f1)"
          else
            echo "âš ï¸ Build completed but firmware not found"
            find bin -name "*.bin" -type f 2>/dev/null | head -5
          fi
        else
          echo "âŒ Build failed"
          echo "Last errors:"
          tail -50 build.log | grep -i "error\|fail"
          exit 1
        fi
    
    - name: Upload fixed firmware
      uses: actions/upload-artifact@v4
      with:
        name: k2p-fixed-${{ github.event.inputs.openwrt_version }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
        retention-days: 7
    
    - name: Create success summary
      if: success()
      run: |
        echo "## âœ… Fix Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Problem Fixed:** dnsmasq package conflict resolved" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Solution:** Using dnsmasq-full package only" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Firmware is available in the artifacts." >> $GITHUB_STEP_SUMMARY
