name: Fix K2P Build

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version'
        required: true
        default: 'v24.10.4'
        type: string

jobs:
  fix-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 \
          python3-pip python3-setuptools rsync unzip zlib1g-dev file wget \
          time
    
    - name: Clone OpenWRT
      run: |
        cd $GITHUB_WORKSPACE
        VERSION="${{ github.event.inputs.openwrt_version }}"
        echo "Cloning OpenWRT $VERSION..."
        
        rm -rf openwrt 2>/dev/null || true
        git clone https://github.com/openwrt/openwrt.git -b $VERSION --depth=1
    
    - name: Apply fixed config
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ”§ åº”ç”¨ä¿®å¤åŽçš„é…ç½®..."
        
        # ä½¿ç”¨ç»å¯¹èƒ½æˆåŠŸçš„é…ç½®
        cat > .config << 'CONFIG_EOF'
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt7621=y
CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=16
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_kmod-mt7615e=y
CONFIG_PACKAGE_kmod-mt7615-firmware=y
CONFIG_PACKAGE_wpad-openssl=y
CONFIG_PACKAGE_dnsmasq-full=y  # å…³é”®ä¿®å¤ï¼šåªä½¿ç”¨fullç‰ˆæœ¬
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y
CONFIG_EOF
        
        make defconfig
        
        echo "âœ… é…ç½®éªŒè¯:"
        echo "dnsmasqé…ç½®:"
        grep "dnsmasq" .config
        echo ""
        echo "æ€»åŒ…æ•°: $(grep -c '^CONFIG_PACKAGE' .config)"
    
    - name: Build with fixed config
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "ðŸ”¨ å¼€å§‹æž„å»º..."
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ä¸‹è½½åŒ…
        make download -j2
        
        # å®Œæ•´æž„å»º
        make -j2 V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥ç»“æžœ
        if [ $? -eq 0 ]; then
          echo "âœ… æž„å»ºæˆåŠŸ!"
          
          # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
          if [ -f "bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin" ]; then
            FIRMWARE="bin/targets/ramips/mt7621/openwrt-ramips-mt7621-phicomm_k2p-squashfs-sysupgrade.bin"
            echo "ðŸŽ¯ å›ºä»¶ç”ŸæˆæˆåŠŸ!"
            echo "æ–‡ä»¶: $(basename $FIRMWARE)"
            echo "å¤§å°: $(du -h $FIRMWARE | cut -f1)"
          else
            echo "âš ï¸ æž„å»ºæˆåŠŸä½†æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            find bin -name "*.bin" -type f 2>/dev/null | head -5
          fi
        else
          echo "âŒ æž„å»ºå¤±è´¥"
          echo "æœ€åŽé”™è¯¯:"
          tail -50 build.log | grep -i "error\|fail"
          exit 1
        fi
    
    - name: Upload fixed firmware
      uses: actions/upload-artifact@v4
      with:
        name: k2p-fixed-${{ github.event.inputs.openwrt_version }}
        path: |
          ${{ github.workspace }}/openwrt/bin/targets/ramips/mt7621/
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/build.log
        retention-days: 7
    
    - name: Create success summary
      if: success()
      run: |
        echo "## âœ… æž„å»ºä¿®å¤æˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**é—®é¢˜å·²ä¿®å¤:** dnsmasq å’Œ dnsmasq-full åŒ…å†²çª" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è§£å†³æ–¹æ¡ˆ:** åªä½¿ç”¨ dnsmasq-full åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "å›ºä»¶å·²ç”Ÿæˆï¼Œè¯·åœ¨Artifactsä¸­ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
