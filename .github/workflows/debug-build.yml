name: Debug OpenWRT Build

on:
  workflow_dispatch:
    inputs:
      config_type:
        description: 'Configuration type'
        required: true
        default: 'simple'
        type: choice
        options:
        - 'minimal'
        - 'simple'
        - 'extended'

jobs:
  debug-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        echo "Setting up build environment..."
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-pip rsync subversion swig time unzip wget xsltproc zlib1g-dev python3-pyelftools cmake python3-dev p7zip-full jq lzma cpio
        echo "Environment setup complete"
        
    - name: Clone OpenWRT
      run: |
        echo "Cloning OpenWRT source..."
        cd $GITHUB_WORKSPACE
        git clone https://github.com/openwrt/openwrt.git --depth=1
        cd openwrt
        echo "OpenWRT cloned to: $(pwd)"
        
    - name: Test basic OpenWRT
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "Testing basic OpenWRT commands..."
        
        echo "1. Testing feeds script..."
        ./scripts/feeds update -a
        echo "Feeds update completed"
        
    - name: Apply test config
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        
        echo "Creating test config..."
        
        # 使用简单的echo创建配置，避免heredoc问题
        echo "CONFIG_TARGET_ramips=y" > .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config
        
        echo "Config created"
